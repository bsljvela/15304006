name: Deploy Django and React

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    name: Build and Deploy Django and React
    runs-on: ubuntu-latest

    steps:
      # 1. Chequear el código del repositorio
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Configurar Node.js para construir React
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # 3. Instalar y construir el proyecto React
      - name: Install and build React
        working-directory: frontend
        run: |
          npm install
          npm run build || (echo "Build failed!" && exit 1)

      - name: Move build files
        run: |
          # Mover archivos de React
          #mkdir -p assets
          mv frontend/dist/assets assets
          mv frontend/dist/index.html index.html

      # 4. Configurar Python para Django
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # 5. Instalar dependencias de Django
      - name: Install Django dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 6. Recolectar archivos estáticos de Django
      - name: Collect static files
        working-directory: backend
        run: python manage.py collectstatic --noinput

      # 7. Preparar la rama de despliegue
      - name: Prepare deploy branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan deploy
          git reset --hard

      # 8. Mover los archivos generados al repositorio
      - name: Move build files
        run: |
          # Mover archivos relevantes de Django
          mkdir -p deploy/backend
          cp -R backend/* /

      # 9. Subir los cambios a la rama `deploy`
      - name: Commit and push to deploy branch
        run: |
          cd deploy
          git add .
          git commit -m "Deploy build $(date)"
          git push --force origin deploy
